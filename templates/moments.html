<!doctype html>
<html
  xmlns:th="https://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = ${singlePage != null ? singlePage.spec.title : '碎碎念'}, content = ~{::content}, head = ~{::head})}"
  data-fp="55018a22"
  data-theme-build="1770439357"
>
  <th:block th:fragment="head">
    <link rel="stylesheet" th:href="@{/assets/css/moments.css}" />
  </th:block>
  <th:block th:fragment="content">
    <main class="main">
      <div class="container">
        <section
          class="moments-page"
          th:with="momentsResult = ${momentFinder != null ? momentFinder.list(1, 50) : null}"
        >
          <div class="moments-header" data-aos="fade-up">
            <h1 class="moments-title" th:text="${singlePage != null ? singlePage.spec.title : '碎碎念'}">碎碎念</h1>
            <p class="moments-subtitle">记录生活中的点滴，留住那些值得回忆的瞬间</p>
            <div class="moments-stats" th:if="${momentsResult != null}">
              <div class="moments-stat">
                <span class="moments-stat-num" th:text="${momentsResult.total}">0</span>
                <span class="moments-stat-label">条动态</span>
              </div>
            </div>
          </div>
          <div th:if="${momentFinder == null}" class="moments-empty" data-aos="fade-up">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            </svg>
            <p>碎碎念功能需要安装「瞬间」插件</p>
          </div>
          <th:block th:if="${momentFinder != null && momentsResult != null}">
            <div class="moments-container">
              <div class="moments-list">
                <th:block th:each="moment, iterStat : ${momentsResult.items}">
                  <div
                    class="moment-item"
                    data-aos="fade-up"
                    th:attr="data-aos-delay=${iterStat.index * 80}"
                    th:with="content = ${moment.spec.content}"
                  >
                    <img
                      class="moment-avatar"
                      th:src="${moment.owner != null && moment.owner.avatar != null ? moment.owner.avatar : (theme.config.hero.avatar ?: '/themes/theme-crayon-shinchan/assets/public/ics6.webp')}"
                      alt="avatar"
                    />
                    <div class="moment-bubble">
                      <div class="moment-bubble-header">
                        <span
                          class="moment-author"
                          th:text="${moment.owner != null && moment.owner.displayName != null ? moment.owner.displayName : theme.config.basic.author}"
                        >
                          作者
                        </span>
                        <span
                          class="moment-time"
                          th:text="${moment.spec.releaseTime != null ? #temporals.format(moment.spec.releaseTime, 'yyyy-MM-dd HH:mm:ss') : ''}"
                        >
                          时间
                        </span>
                      </div>
                      <div
                        class="moment-content"
                        th:if="${content != null && content.html != null && !#strings.isEmpty(content.html)}"
                        th:utext="${content.html}"
                      >
                        内容
                      </div>
                      <div
                        class="moment-media"
                        th:if="${content != null && content.medium != null && !#lists.isEmpty(content.medium)}"
                      >
                        <th:block th:each="medium : ${content.medium}">
                          <img
                            th:if="${medium.type.name() == 'PHOTO'}"
                            th:src="${medium.url}"
                            class="moment-img"
                            alt="图片"
                            loading="lazy"
                          />
                          <video
                            th:if="${medium.type.name() == 'VIDEO'}"
                            th:src="${medium.url}"
                            class="moment-video"
                            controls
                            preload="metadata"
                          ></video>
                          <audio
                            th:if="${medium.type.name() == 'AUDIO'}"
                            th:src="${medium.url}"
                            class="moment-audio"
                            controls
                          ></audio>
                        </th:block>
                      </div>
                      <div class="moment-tags" th:if="${moment.spec.tags != null && !#lists.isEmpty(moment.spec.tags)}">
                        <span class="moment-tag" th:each="tag : ${moment.spec.tags}" th:text="'#' + ${tag}">#标签</span>
                      </div>
                      <div class="moment-footer">
                        <button
                          class="moment-action-btn moment-comment-btn"
                          th:attr="data-moment-name=${moment.metadata.name}"
                        >
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                          </svg>
                          <span th:text="${moment.stats != null ? moment.stats.approvedComment : 0}">0</span>
                        </button>
                      </div>
                      <div class="moment-comments" th:id="'comments-' + ${moment.metadata.name}">
                        <halo:comment
                          group="moment.halo.run"
                          kind="Moment"
                          th:name="${moment.metadata.name}"
                          colorScheme="auto"
                        />
                      </div>
                    </div>
                  </div>
                </th:block>
              </div>
              <div class="moments-pagination" th:if="${momentsResult.totalPages> 1}" data-aos="fade-up">
                <span
                  class="pagination-info"
                  th:text="|第 ${momentsResult.page} 页 / 共 ${momentsResult.totalPages} 页|"
                >
                  分页信息
                </span>
              </div>
              <div class="moments-empty" th:if="${#lists.isEmpty(momentsResult.items)}" data-aos="fade-up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                <p>暂无动态</p>
              </div>
            </div>
          </th:block>
        </section>
      </div>
    </main>
    <script th:inline="javascript">
      ;(function () {
        document.addEventListener('click', (e) => {
          const commentBtn = e.target.closest('.moment-comment-btn')
          if (!commentBtn) return

          const name = commentBtn.dataset.momentName
          const commentsEl = document.getElementById('comments-' + name)

          if (commentsEl) {
            commentsEl.classList.toggle('active')
            commentBtn.classList.toggle('active')
          }
        })
      })()
    </script>
  </th:block>
</html>
